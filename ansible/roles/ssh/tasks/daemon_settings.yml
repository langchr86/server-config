---

- name: "Daemon settings: global"
  become: true
  ansible.builtin.lineinfile:
    dest: "{{ sshd_config_file }}"
    line: "{{ item.line }}"
    regexp: "{{ item.regexp }}"
    state: present
    insertafter: EOF
    create: true
    mode: "u+rw"
  with_items:
    - {regexp: "^X11Forwarding", line: "X11Forwarding no"}
  notify: restart sshd

- name: "Daemon hardening: global"
  become: true
  ansible.builtin.lineinfile:
    dest: "{{ sshd_config_file }}"
    line: "{{ item.line }}"
    regexp: "{{ item.regexp }}"
    state: present
    insertafter: EOF
    create: true
    mode: "u+rw"
  with_items:
    - {regexp: "^PermitRootLogin", line: "PermitRootLogin no"}
    - {regexp: "^PermitEmptyPasswords", line: "PermitEmptyPasswords no"}
    - {regexp: "^PubkeyAuthentication", line: "PubkeyAuthentication yes"}
    - {regexp: "^ChallengeResponseAuthentication", line: "ChallengeResponseAuthentication no"}
    - {regexp: "^KerberosAuthentication ", line: "KerberosAuthentication no"}
    - {regexp: "^GSSAPIAuthentication ", line: "GSSAPIAuthentication no"}
    - {regexp: "^PasswordAuthentication", line: "PasswordAuthentication no"}
    - {regexp: "^AllowTcpForwarding", line: "AllowTcpForwarding no"}
    - {regexp: "^X11Forwarding", line: "X11Forwarding no"}
    - {regexp: "^PermitTunnel", line: "PermitTunnel no"}
    - {regexp: "^AllowUsers", line: "AllowUsers {{ ssh_allowed_users|join(' ') }}"}
  notify: restart sshd

- name: "Daemon hardening: local network"
  become: true
  ansible.builtin.blockinfile:
    path: "{{ sshd_config_file }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK: Daemon hardening: local network"
    block: |
      Match Address 192.168.0.0/24
        PasswordAuthentication yes
      Match all
  notify: restart sshd
